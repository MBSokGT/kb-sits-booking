# 🏗️ Архитектура системы КБ Ситс + Supabase

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         АРХИТЕКТУРА СИСТЕМЫ                             │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                            FRONTEND (Браузер)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │  index.html  │  │   style.css  │  │    app.js    │                 │
│  │              │  │              │  │              │                 │
│  │  - Разметка  │  │  - Стили     │  │  - Логика    │                 │
│  │  - Формы     │  │  - Анимации  │  │  - События   │                 │
│  │  - Модалки   │  │  - Адаптив   │  │  - UI        │                 │
│  └──────┬───────┘  └──────────────┘  └──────┬───────┘                 │
│         │                                    │                         │
│         └────────────────┬───────────────────┘                         │
│                          │                                             │
│                          ▼                                             │
│              ┌───────────────────────┐                                 │
│              │   supabase-api.js     │                                 │
│              │                       │                                 │
│              │  - login()            │                                 │
│              │  - getFloors()        │                                 │
│              │  - createBooking()    │                                 │
│              │  - subscribeToXXX()   │                                 │
│              └───────────┬───────────┘                                 │
│                          │                                             │
│                          ▼                                             │
│              ┌───────────────────────┐                                 │
│              │  Supabase JS Client   │                                 │
│              │  (@supabase/supabase) │                                 │
│              └───────────┬───────────┘                                 │
│                          │                                             │
└──────────────────────────┼─────────────────────────────────────────────┘
                           │
                           │ HTTP/WebSocket
                           │
┌──────────────────────────┼─────────────────────────────────────────────┐
│                          ▼                                             │
│                    SUPABASE (Docker)                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────┐    │
│  │                     Kong API Gateway                          │    │
│  │                   (localhost:54321)                           │    │
│  │                                                               │    │
│  │  - Маршрутизация                                              │    │
│  │  - Авторизация (JWT)                                          │    │
│  │  - CORS                                                       │    │
│  └─────────────┬─────────────────────────────┬───────────────────┘    │
│                │                             │                        │
│                ▼                             ▼                        │
│  ┌─────────────────────────┐   ┌─────────────────────────┐           │
│  │      PostgREST API      │   │    Supabase Studio     │           │
│  │    (REST endpoints)     │   │   (localhost:3000)     │           │
│  │                         │   │                        │           │
│  │  - GET /rest/v1/users   │   │  - SQL Editor          │           │
│  │  - POST /rest/v1/...    │   │  - Table Editor        │           │
│  │  - Real-time channels   │   │  - Auth Manager        │           │
│  └────────────┬────────────┘   │  - API Settings        │           │
│               │                └────────────────────────┘           │
│               │                                                      │
│               ▼                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                  PostgreSQL Database                        │   │
│  │                  (localhost:54322)                          │   │
│  │                                                             │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │   │
│  │  │ departments  │  │    users     │  │    floors    │     │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │   │
│  │         │                 │                 │              │   │
│  │         └─────────────────┴─────────────────┘              │   │
│  │                           │                                │   │
│  │  ┌──────────────┐  ┌──────┴───────┐  ┌──────────────┐     │   │
│  │  │    zones     │  │    seats     │  │   bookings   │     │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘     │   │
│  │                                                             │   │
│  │  + Row Level Security (RLS)                                │   │
│  │  + Triggers & Functions                                    │   │
│  │  + Indexes                                                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                         ПОТОК ДАННЫХ (ПРИМЕР)                          │
└─────────────────────────────────────────────────────────────────────────┘

1. Пользователь нажимает "Забронировать место"
   │
   ▼
2. app.js вызывает api.createBooking(seatId, userId, date, timeSlot)
   │
   ▼
3. supabase-api.js отправляет POST запрос через Supabase Client
   │
   ▼
4. Kong API Gateway проверяет JWT токен
   │
   ▼
5. PostgREST преобразует запрос в SQL
   │
   ▼
6. PostgreSQL проверяет RLS политики:
   - Авторизован ли пользователь?
   - Есть ли права на бронирование?
   - Свободно ли место?
   │
   ▼
7. Если OK → INSERT в таблицу bookings
   │
   ▼
8. Триггер обновляет updated_at
   │
   ▼
9. Real-time канал отправляет уведомление всем подписчикам
   │
   ▼
10. Браузеры получают WebSocket событие
    │
    ▼
11. app.js обновляет UI (показывает новое бронирование)


┌─────────────────────────────────────────────────────────────────────────┐
│                      БЕЗОПАСНОСТЬ (RLS)                                 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────┐
│   Запрос    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│  Kong: Проверка JWT токена          │
│  - Извлечение user_id из токена     │
│  - Проверка срока действия          │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│  PostgreSQL: RLS политики           │
│                                     │
│  IF role = 'employee' THEN          │
│    - Может бронировать себе         │
│    - Видит всех пользователей       │
│                                     │
│  IF role = 'manager' THEN           │
│    - Может бронировать для отдела   │
│    - Видит свой отдел               │
│                                     │
│  IF role = 'admin' THEN             │
│    - Полный доступ                  │
│                                     │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│  Результат: Разрешено / Запрещено   │
└─────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                      REAL-TIME ОБНОВЛЕНИЯ                               │
└─────────────────────────────────────────────────────────────────────────┘

Браузер 1                    Supabase                    Браузер 2
    │                            │                            │
    │  subscribeToBookings()     │                            │
    ├───────────────────────────>│                            │
    │                            │  subscribeToBookings()     │
    │                            │<───────────────────────────┤
    │                            │                            │
    │  createBooking()           │                            │
    ├───────────────────────────>│                            │
    │                            │                            │
    │                       [INSERT в БД]                     │
    │                            │                            │
    │                       [Триггер]                         │
    │                            │                            │
    │  ← WebSocket событие       │  WebSocket событие →       │
    │<───────────────────────────┼───────────────────────────>│
    │                            │                            │
    │  [Обновить UI]             │             [Обновить UI]  │
    │                            │                            │


┌─────────────────────────────────────────────────────────────────────────┐
│                      МАСШТАБИРОВАНИЕ                                    │
└─────────────────────────────────────────────────────────────────────────┘

Текущая архитектура (локальная):
  - 1 PostgreSQL инстанс
  - 1 PostgREST инстанс
  - Подходит для: 10-100 пользователей

Для production (Supabase Cloud):
  - Автоматическое масштабирование
  - CDN для статики
  - Репликация БД
  - Подходит для: 1000+ пользователей


┌─────────────────────────────────────────────────────────────────────────┐
│                      РЕЗЕРВНОЕ КОПИРОВАНИЕ                              │
└─────────────────────────────────────────────────────────────────────────┘

Автоматический бэкап (настроить cron):
  ┌─────────────────────────────────────┐
  │  docker exec kb_sits_db pg_dump ... │
  └─────────────────┬───────────────────┘
                    │
                    ▼
  ┌─────────────────────────────────────┐
  │  backup-2024-01-15.sql              │
  └─────────────────────────────────────┘

Восстановление:
  ┌─────────────────────────────────────┐
  │  docker exec -i kb_sits_db psql ... │
  └─────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                      МОНИТОРИНГ                                         │
└─────────────────────────────────────────────────────────────────────────┘

Supabase Studio → Logs:
  - SQL запросы
  - Ошибки
  - Производительность

PostgreSQL:
  - pg_stat_statements (статистика запросов)
  - pg_stat_activity (активные соединения)

Браузер:
  - Console.log для отладки
  - Network tab для API запросов
```
